generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ========== NEXTAUTH TABLES ==========
model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ========== USERS/EMPLOYES ==========

model User {
  id            String      @id @default(cuid())
  cin           String?     @unique                // Optionnel: le CIN RH (peut être nul pour admin technique)
  name          String?
  lastName      String?     @map("last_name")
  email         String      @unique
  emailVerified DateTime?   @map("email_verified")
  password      String?
  image         String?     @db.LongText           // url photo (Google) or base64 for uploaded photos
  sexe          Sexe?
  rib           String?     @db.VarChar(24)
  adresse       String?
  telephone     String?
  dateEmbauche  DateTime?   @map("date_embauche")
  typeContrat   ContratType?@map("type_contrat")
  roleEnum      Role        @default(USER)            // rôle simplifié pour NextAuth
  role          RoleEntity? @relation(fields: [roleId], references: [id])
  roleId        String?
  status        UserStatus  @default(INACTIVE)        // Status for user lifecycle
  isActive      Boolean     @default(true) @map("is_active")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  accounts        Account[]
  sessions        Session[]
  employee        Employe?                              // relation one-to-one avec Employe
  dossiers        DossierEmploye[]
  demandesConge   DemandeConge[]
  pointages       Pointage[]
  auditLogs       AuditLog[]
  notifications   Notification[]
  rhDecisions     RHDecision[]     @relation("RHDecider")
  deviceFingerprints DeviceFingerprint[]
  cookieConsents  CookieConsent[]
  userSessions    UserSession[]

  @@map("User")
}

// Enums RH
enum Sexe {
  HOMME
  FEMME
}
enum ContratType {
  CDI
  CDD
  Stage
  Freelance
}
enum Role {
  SUPER_ADMIN
  RH
  USER
}
enum UserStatus {
  INACTIVE      // Registered but profile not completed
  PENDING       // Profile completed, waiting for RH validation
  ACTIVE        // Approved by RH, full access
  REJECTED      // Rejected by RH
  SUSPENDED     // Temporarily suspended
}

// ========== PASSWORD RESET ==========
model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([email, token])
  @@map("password_reset_tokens")
}

// ========== OTP VERIFICATION ==========
model OTPToken {
  id        String   @id @default(cuid())
  email     String
  code      String   // 6-digit OTP code (hashed)
  expires   DateTime
  verified  Boolean  @default(false)
  attempts  Int      @default(0) // Track failed attempts
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([email, code])
  @@index([email])
  @@map("otp_tokens")
}

// ========== ROLE & PERMISSIONS ==========
model RoleEntity {
  id              String           @id @default(cuid())
  name            String           @unique
  description     String?
  users           User[]
  rolePermissions RolePermission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("roles")
}

model Permission {
  id     String           @id @default(cuid())
  module String // (ex: RH, Paramètres, Chatbot, ...)
  type   PermissionType
  action PermissionAction

  rolePermissions RolePermission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("permissions")
}

model RolePermission {
  id           String @id @default(cuid())
  roleId       String
  permissionId String

  role       RoleEntity @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

enum PermissionType {
  BASE
  ADVANCED
}
enum PermissionAction {
  ADD
  DELETE
  EDIT
  VIEW
  ACTIVATE
  VALIDATE
  VERIFY
  PROCESS
}

// ========== DOSSIERS EMPLOYES ==========
model DossierEmploye {
  id            String       @id @default(cuid())
  userId        String
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  type          DossierType
  titre         String
  description   String?
  fichier       String?
  dateObtention DateTime?    @map("date_obtention")

  @@map("dossier_employe")
}

enum DossierType {
  DIPLOME
  CERTIFICAT
  ATTESTATION
}

// ========== DEMANDES DE CONGÉ ==========
model DemandeConge {
  id         String        @id @default(cuid())
  userId     String
  user       User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  type       CongeType
  dateDebut  DateTime      @map("date_debut")
  dateFin    DateTime      @map("date_fin")
  status     StatutConge   @default(EN_ATTENTE)
  commentaire String?

  @@map("demande_conge")
}

enum CongeType {
  PAID
  UNPAID
  MATERNITE
  MALADIE
  PREAVIS
}
enum StatutConge {
  EN_ATTENTE
  VALIDE
  REFUSE
}

// ========== EMPLOYE ==========
model Employe {
  id            String         @id @default(cuid())
  userId        String         @unique @map("user_id")
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  nom           String?
  prenom        String?
  email         String?
  birthday      DateTime?
  sexe          Sexe?
  rib           String?        @db.VarChar(24)
  adresse       String?
  telephone     String?
  dateEmbauche  DateTime?      @map("date_embauche")
  photo         String?        @db.LongText // URL or base64 of photo
  cv            String?        @db.LongText // URL or base64 of CV
  typeContrat   ContratType?   @map("type_contrat")
  position      String?        // Job position
  department    String?        // Department
  status        EmployeStatus  @default(EN_ATTENTE)
  rejectionReason String?      @db.Text @map("rejection_reason")
  approvedBy    String?        @map("approved_by")
  approvedAt    DateTime?      @map("approved_at")
  autresDocuments String?      @db.LongText @map("autres_documents") // JSON documents
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  rhDecisions   RHDecision[]

  @@map("Employe")
}

enum EmployeStatus {
  EN_ATTENTE    // Waiting for RH validation
  APPROUVE      // Approved by RH
  REJETE        // Rejected by RH
}

// ========== POINTAGE SYSTEM ==========
model Pointage {
  id                  String            @id @default(cuid())
  userId              String            @map("user_id")
  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  type                PointageType
  timestamp           DateTime          @default(now())
  deviceFingerprintId String?           @map("device_fingerprint_id")
  deviceFingerprint   DeviceFingerprint? @relation(fields: [deviceFingerprintId], references: [id])
  ipAddress           String?           @map("ip_address")
  geolocation         String?           @db.Text // JSON: {lat, lng, accuracy}
  capturedPhoto       String?           @db.LongText @map("captured_photo") // base64 photo
  faceVerified        Boolean           @default(false) @map("face_verified")
  verificationScore   Float?            @map("verification_score") // 0-100
  anomalyDetected     Boolean           @default(false) @map("anomaly_detected")
  anomalyReason       String?           @db.Text @map("anomaly_reason")
  status              PointageStatus    @default(VALID)
  notes               String?           @db.Text
  
  createdAt           DateTime          @default(now()) @map("created_at")
  
  anomalies           Anomaly[]

  @@index([userId, timestamp])
  @@index([type, timestamp])
  @@map("pointages")
}

enum PointageType {
  IN        // Check-in
  OUT       // Check-out
}

enum PointageStatus {
  VALID
  PENDING_REVIEW
  REJECTED
  CORRECTED
}

// ========== DEVICE FINGERPRINT ==========
model DeviceFingerprint {
  id                String   @id @default(cuid())
  userId            String   @map("user_id")
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  fingerprint       String   @db.Text // JSON of device info
  userAgent         String   @db.Text @map("user_agent")
  platform          String?
  browser           String?
  screenResolution  String?  @map("screen_resolution")
  timezone          String?
  language          String?
  firstSeen         DateTime @default(now()) @map("first_seen")
  lastSeen          DateTime @updatedAt @map("last_seen")
  isTrusted         Boolean  @default(false) @map("is_trusted")
  
  pointages         Pointage[]
  
  @@index([userId])
  @@map("device_fingerprints")
}

// ========== ANOMALIES ==========
model Anomaly {
  id          String        @id @default(cuid())
  type        AnomalyType
  severity    AnomalySeverity
  entityType  String        @map("entity_type") // "pointage", "user", "login", etc.
  entityId    String        @map("entity_id")
  pointageId  String?       @map("pointage_id")
  pointage    Pointage?     @relation(fields: [pointageId], references: [id], onDelete: Cascade)
  description String        @db.Text
  metadata    String?       @db.LongText // JSON additional data
  status      AnomalyStatus @default(PENDING)
  resolvedBy  String?       @map("resolved_by")
  resolvedAt  DateTime?     @map("resolved_at")
  resolution  String?       @db.Text
  
  createdAt   DateTime      @default(now()) @map("created_at")
  
  @@index([type, status])
  @@index([severity, status])
  @@index([createdAt])
  @@map("anomalies")
}

enum AnomalyType {
  UNUSUAL_HOURS         // Pointage outside normal hours
  MULTIPLE_DEVICES      // Multiple devices in short time
  FACE_VERIFICATION_FAIL // Face not matching
  IMPOSSIBLE_LOCATION   // Geo location mismatch
  DUPLICATE_POINTAGE    // Duplicate within short time
  SUSPICIOUS_PATTERN    // Unusual pattern detected
  MISSING_CHECKOUT      // Check-in without check-out
  SYSTEM_ERROR          // Technical error
}

enum AnomalySeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum AnomalyStatus {
  PENDING
  INVESTIGATING
  RESOLVED
  FALSE_POSITIVE
  IGNORED
}

// ========== AUDIT LOG ==========
model AuditLog {
  id          String        @id @default(cuid())
  userId      String?       @map("user_id")
  user        User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  action      String        // "CREATE", "UPDATE", "DELETE", "LOGIN", "LOGOUT", etc.
  entityType  String        @map("entity_type") // "User", "Employe", "Pointage", etc.
  entityId    String?       @map("entity_id")
  changes     String?       @db.LongText // JSON of before/after
  ipAddress   String?       @map("ip_address")
  userAgent   String?       @db.Text @map("user_agent")
  metadata    String?       @db.LongText // Additional context
  severity    LogSeverity   @default(INFO)
  
  createdAt   DateTime      @default(now()) @map("created_at")
  
  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

enum LogSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}

// ========== NOTIFICATIONS ==========
model Notification {
  id          String             @id @default(cuid())
  userId      String             @map("user_id")
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        NotificationType
  title       String
  message     String             @db.Text
  metadata    String?            @db.LongText // JSON additional data
  isRead      Boolean            @default(false) @map("is_read")
  readAt      DateTime?          @map("read_at")
  priority    NotificationPriority @default(NORMAL)
  
  createdAt   DateTime           @default(now()) @map("created_at")
  
  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  PROFILE_APPROVED
  PROFILE_REJECTED
  PROFILE_SUBMITTED
  POINTAGE_ANOMALY
  POINTAGE_SUCCESS
  LEAVE_REQUEST
  SYSTEM_ALERT
  RH_ACTION_REQUIRED
  DOCUMENT_REQUIRED
  GENERAL
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// ========== RH DECISIONS ==========
model RHDecision {
  id          String         @id @default(cuid())
  employeId   String         @map("employe_id")
  employe     Employe        @relation(fields: [employeId], references: [id], onDelete: Cascade)
  deciderId   String         @map("decider_id")
  decider     User           @relation("RHDecider", fields: [deciderId], references: [id], onDelete: Cascade)
  decision    DecisionType
  reason      String?        @db.Text
  comments    String?        @db.Text
  metadata    String?        @db.LongText // JSON additional data
  
  createdAt   DateTime       @default(now()) @map("created_at")
  
  @@index([employeId])
  @@index([deciderId])
  @@index([createdAt])
  @@map("rh_decisions")
}

enum DecisionType {
  APPROVED
  REJECTED
  SUSPENDED
  REACTIVATED
  UPDATED
}

// ========== COOKIE CONSENT (GDPR) ==========
model CookieConsent {
  id                  String   @id @default(cuid())
  sessionId           String?  @map("session_id") // For anonymous users
  userId              String?  @map("user_id") // For authenticated users
  user                User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Consent preferences
  necessary           Boolean  @default(true) // Always true, cannot be disabled
  functional          Boolean  @default(false) // Session, language, theme preferences
  analytics           Boolean  @default(false) // Analytics and tracking
  marketing           Boolean  @default(false) // Marketing and advertising
  
  // Consent metadata
  consentVersion      String   @default("1.0") @map("consent_version")
  consentMethod       String   @default("banner") @map("consent_method") // banner, settings, api
  ipAddress           String?  @map("ip_address")
  userAgent           String?  @db.Text @map("user_agent")
  
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  @@index([userId])
  @@index([sessionId])
  @@index([createdAt])
  @@map("cookie_consents")
}

// ========== USER SESSIONS (Enhanced) ==========
model UserSession {
  id                  String   @id @default(cuid())
  userId              String   @map("user_id")
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Session info
  sessionToken        String   @unique @map("session_token")
  refreshToken        String?  @unique @map("refresh_token")
  
  // Device info
  deviceFingerprint   String?  @db.Text @map("device_fingerprint")
  userAgent           String?  @db.Text @map("user_agent")
  ipAddress           String?  @map("ip_address")
  platform            String?
  browser             String?
  
  // Session state
  isActive            Boolean  @default(true) @map("is_active")
  lastActivity        DateTime @default(now()) @map("last_activity")
  expiresAt           DateTime @map("expires_at")
  
  // Security
  csrfToken           String?  @map("csrf_token")
  revokedAt           DateTime? @map("revoked_at")
  revokedReason       String?  @map("revoked_reason")
  
  createdAt           DateTime @default(now()) @map("created_at")
  
  @@index([userId])
  @@index([sessionToken])
  @@index([isActive, expiresAt])
  @@map("user_sessions")
}